<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Winning Side — Standalone</title>

    <!-- Tailwind (quick styling) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + Babel (dev compile of JSX) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase compat (simplest for one-file hosting) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  </head>
  <body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState, useEffect } = React;

      // === Brand & Firebase ===
      const LOGO_URL = "https://dummyimage.com/160x40/059669/ffffff&text=Winning+Side";
      const FIREBASE_ENABLED = true;
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyCtti9Ll57zmSXvG4RofN_yQa7y2uVCGC0",
        authDomain: "winning-team-6364c.firebaseapp.com",
        projectId: "winning-team-6364c",
        storageBucket: "winning-team-6364c.firebasestorage.app",
        messagingSenderId: "944401986892",
        appId: "1:944401986892:web:8fad1c4d395acceed50be9",
        measurementId: "G-B8TT9WKWEX"
      };

      // ===== Players (retired) =====
      const ALL_PLAYERS = [
        // GK (16)
        { id: "yashin", name: "Lev Yashin", country: "USSR", position: "GK", rating: 97 },
        { id: "buffon", name: "Gianluigi Buffon", country: "Italy", position: "GK", rating: 94 },
        { id: "casillas", name: "Iker Casillas", country: "Spain", position: "GK", rating: 92 },
        { id: "schmeichel", name: "Peter Schmeichel", country: "Denmark", position: "GK", rating: 93 },
        { id: "maier", name: "Sepp Maier", country: "Germany", position: "GK", rating: 91 },
        { id: "zoff", name: "Dino Zoff", country: "Italy", position: "GK", rating: 92 },
        { id: "kahn", name: "Oliver Kahn", country: "Germany", position: "GK", rating: 93 },
        { id: "banks", name: "Gordon Banks", country: "England", position: "GK", rating: 92 },
        { id: "chilavert", name: "José Luis Chilavert", country: "Paraguay", position: "GK", rating: 89 },
        { id: "higuita", name: "René Higuita", country: "Colombia", position: "GK", rating: 87 },
        { id: "vanDerSar", name: "Edwin van der Sar", country: "Netherlands", position: "GK", rating: 91 },
        { id: "deGeaOld", name: "David de Gea", country: "Spain", position: "GK", rating: 88 },
        { id: "dasaev", name: "Rinat Dasayev", country: "USSR", position: "GK", rating: 91 },
        { id: "valdes", name: "Víctor Valdés", country: "Spain", position: "GK", rating: 88 },
        { id: "seaman", name: "David Seaman", country: "England", position: "GK", rating: 89 },
        { id: "schwarzer", name: "Mark Schwarzer", country: "Australia", position: "GK", rating: 85 },

        // DEF (32)
        { id: "maldini", name: "Paolo Maldini", country: "Italy", position: "DEF", rating: 96 },
        { id: "beckenbauer", name: "Franz Beckenbauer", country: "Germany", position: "DEF", rating: 97 },
        { id: "cafu", name: "Cafu", country: "Brazil", position: "DEF", rating: 90 },
        { id: "carlosalberto", name: "Carlos Alberto", country: "Brazil", position: "DEF", rating: 92 },
        { id: "robertocarlos", name: "Roberto Carlos", country: "Brazil", position: "DEF", rating: 92 },
        { id: "ferdinand", name: "Rio Ferdinand", country: "England", position: "DEF", rating: 90 },
        { id: "puyol", name: "Carles Puyol", country: "Spain", position: "DEF", rating: 91 },
        { id: "baresi", name: "Franco Baresi", country: "Italy", position: "DEF", rating: 95 },
        { id: "montero", name: "Paolo Montero", country: "Uruguay", position: "DEF", rating: 87 },
        { id: "zanetti", name: "Javier Zanetti", country: "Argentina", position: "DEF", rating: 92 },
        { id: "lahm", name: "Philipp Lahm", country: "Germany", position: "DEF", rating: 92 },
        { id: "ramos", name: "Sergio Ramos", country: "Spain", position: "DEF", rating: 92 },
        { id: "hierro", name: "Fernando Hierro", country: "Spain", position: "DEF", rating: 91 },
        { id: "cole", name: "Ashley Cole", country: "England", position: "DEF", rating: 90 },
        { id: "vidic", name: "Nemanja Vidić", country: "Serbia", position: "DEF", rating: 91 },
        { id: "campbell", name: "Sol Campbell", country: "England", position: "DEF", rating: 89 },
        { id: "desailly", name: "Marcel Desailly", country: "France", position: "DEF", rating: 92 },
        { id: "moore", name: "Bobby Moore", country: "England", position: "DEF", rating: 95 },
        { id: "cannavaro", name: "Fabio Cannavaro", country: "Italy", position: "DEF", rating: 94 },
        { id: "nesta", name: "Alessandro Nesta", country: "Italy", position: "DEF", rating: 93 },
        { id: "tassotti", name: "Mauro Tassotti", country: "Italy", position: "DEF", rating: 88 },
        { id: "alba", name: "Jordi Alba", country: "Spain", position: "DEF", rating: 88 },
        { id: "godin", name: "Diego Godín", country: "Uruguay", position: "DEF", rating: 90 },
        { id: "ayala", name: "Roberto Ayala", country: "Argentina", position: "DEF", rating: 90 },
        { id: "brehme", name: "Andreas Brehme", country: "Germany", position: "DEF", rating: 90 },
        { id: "koeman", name: "Ronald Koeman", country: "Netherlands", position: "DEF", rating: 92 },
        { id: "stam", name: "Jaap Stam", country: "Netherlands", position: "DEF", rating: 90 },
        { id: "thuram", name: "Lilian Thuram", country: "France", position: "DEF", rating: 92 },
        { id: "figueroa", name: "Elias Figueroa", country: "Chile", position: "DEF", rating: 93 },
        { id: "scirea", name: "Gaetano Scirea", country: "Italy", position: "DEF", rating: 93 },
        { id: "facchetti", name: "Giacinto Facchetti", country: "Italy", position: "DEF", rating: 93 },
        { id: "santamaria", name: "José Santamaría", country: "Uruguay", position: "DEF", rating: 92 },
        { id: "passarella", name: "Daniel Passarella", country: "Argentina", position: "DEF", rating: 94 },

        // MID (36)
        { id: "zidane", name: "Zinedine Zidane", country: "France", position: "MID", rating: 97 },
        { id: "xavi", name: "Xavi", country: "Spain", position: "MID", rating: 95 },
        { id: "iniesta", name: "Andres Iniesta", country: "Spain", position: "MID", rating: 95 },
        { id: "pirlo", name: "Andrea Pirlo", country: "Italy", position: "MID", rating: 94 },
        { id: "scholes", name: "Paul Scholes", country: "England", position: "MID", rating: 90 },
        { id: "beckham", name: "David Beckham", country: "England", position: "MID", rating: 89 },
        { id: "platini", name: "Michel Platini", country: "France", position: "MID", rating: 95 },
        { id: "kaka", name: "Kaká", country: "Brazil", position: "MID", rating: 92 },
        { id: "ronaldinho", name: "Ronaldinho", country: "Brazil", position: "MID", rating: 95 },
        { id: "matthaus", name: "Lothar Matthäus", country: "Germany", position: "MID", rating: 93 },
        { id: "riquelme", name: "Juan Román Riquelme", country: "Argentina", position: "MID", rating: 92 },
        { id: "lampard", name: "Frank Lampard", country: "England", position: "MID", rating: 90 },
        { id: "gerrard", name: "Steven Gerrard", country: "England", position: "MID", rating: 91 },
        { id: "figo", name: "Luís Figo", country: "Portugal", position: "MID", rating: 93 },
        { id: "modric", name: "Luka Modrić", country: "Croatia", position: "MID", rating: 94 },
        { id: "busquets", name: "Sergio Busquets", country: "Spain", position: "MID", rating: 92 },
        { id: "davids", name: "Edgar Davids", country: "Netherlands", position: "MID", rating: 90 },
        { id: "seedorf", name: "Clarence Seedorf", country: "Netherlands", position: "MID", rating: 92 },
        { id: "schweinsteiger", name: "Bastian Schweinsteiger", country: "Germany", position: "MID", rating: 90 },
        { id: "gullit", name: "Ruud Gullit", country: "Netherlands", position: "MID", rating: 93 },
        { id: "nedved", name: "Pavel Nedvěd", country: "Czech Republic", position: "MID", rating: 93 },
        { id: "rivaldo", name: "Rivaldo", country: "Brazil", position: "MID", rating: 93 },
        { id: "dunga", name: "Dunga", country: "Brazil", position: "MID", rating: 90 },
        { id: "socrates", name: "Sócrates", country: "Brazil", position: "MID", rating: 93 },
        { id: "totti", name: "Francesco Totti", country: "Italy", position: "MID", rating: 93 },
        { id: "zico", name: "Zico", country: "Brazil", position: "MID", rating: 95 },
        { id: "redondo", name: "Fernando Redondo", country: "Argentina", position: "MID", rating: 92 },
        { id: "makalele", name: "Claude Makélélé", country: "France", position: "MID", rating: 91 },
        { id: "kante", name: "N'Golo Kanté", country: "France", position: "MID", rating: 91 },
        { id: "yaya", name: "Yaya Touré", country: "Côte d'Ivoire", position: "MID", rating: 91 },
        { id: "essien", name: "Michael Essien", country: "Ghana", position: "MID", rating: 89 },
        { id: "sammer", name: "Matthias Sammer", country: "Germany", position: "MID", rating: 91 },
        { id: "keane", name: "Roy Keane", country: "Ireland", position: "MID", rating: 90 },
        { id: "veron", name: "Juan Sebastián Verón", country: "Argentina", position: "MID", rating: 90 },
        { id: "iniesta10", name: "Hristo Stoichkov (AM)", country: "Bulgaria", position: "MID", rating: 91 },
        { id: "baggio10", name: "Roberto Baggio (AM)", country: "Italy", position: "MID", rating: 94 },
        { id: "deco", name: "Deco", country: "Portugal", position: "MID", rating: 90 },

        // FWD (40+)
        { id: "pele", name: "Pelé", country: "Brazil", position: "FWD", rating: 99 },
        { id: "maradona", name: "Diego Maradona", country: "Argentina", position: "FWD", rating: 99 },
        { id: "ronaldo", name: "Ronaldo Nazário", country: "Brazil", position: "FWD", rating: 97 },
        { id: "cruyff", name: "Johan Cruyff", country: "Netherlands", position: "FWD", rating: 97 },
        { id: "henry", name: "Thierry Henry", country: "France", position: "FWD", rating: 94 },
        { id: "shevchenko", name: "Andriy Shevchenko", country: "Ukraine", position: "FWD", rating: 92 },
        { id: "batistuta", name: "Gabriel Batistuta", country: "Argentina", position: "FWD", rating: 94 },
        { id: "vanbasten", name: "Marco van Basten", country: "Netherlands", position: "FWD", rating: 96 },
        { id: "eusebio", name: "Eusébio", country: "Portugal", position: "FWD", rating: 95 },
        { id: "muller", name: "Gerd Müller", country: "Germany", position: "FWD", rating: 96 },
        { id: "romario", name: "Romário", country: "Brazil", position: "FWD", rating: 95 },
        { id: "baggio", name: "Roberto Baggio", country: "Italy", position: "FWD", rating: 94 },
        { id: "weah", name: "George Weah", country: "Liberia", position: "FWD", rating: 91 },
        { id: "raul", name: "Raúl", country: "Spain", position: "FWD", rating: 94 },
        { id: "stoichkov", name: "Hristo Stoichkov", country: "Bulgaria", position: "FWD", rating: 93 },
        { id: "bergkamp", name: "Dennis Bergkamp", country: "Netherlands", position: "FWD", rating: 93 },
        { id: "lineker", name: "Gary Lineker", country: "England", position: "FWD", rating: 92 },
        { id: "rush", name: "Ian Rush", country: "Wales", position: "FWD", rating: 91 },
        { id: "delpiero", name: "Alessandro Del Piero", country: "Italy", position: "FWD", rating: 93 },
        { id: "inzaghi", name: "Filippo Inzaghi", country: "Italy", position: "FWD", rating: 89 },
        { id: "klinsmann", name: "Jürgen Klinsmann", country: "Germany", position: "FWD", rating: 91 },
        { id: "shearer", name: "Alan Shearer", country: "England", position: "FWD", rating: 94 },
        { id: "fowler", name: "Robbie Fowler", country: "England", position: "FWD", rating: 89 },
        { id: "owen", name: "Michael Owen", country: "England", position: "FWD", rating: 90 },
        { id: "etoo", name: "Samuel Eto'o", country: "Cameroon", position: "FWD", rating: 93 },
        { id: "zlatan", name: "Zlatan Ibrahimović", country: "Sweden", position: "FWD", rating: 92 },
        { id: "ronaldinhoF", name: "Ronaldinho (FWD)", country: "Brazil", position: "FWD", rating: 94 },
        { id: "rivaldoF", name: "Rivaldo (FWD)", country: "Brazil", position: "FWD", rating: 93 },
        { id: "klose", name: "Miroslav Klose", country: "Germany", position: "FWD", rating: 91 },
        { id: "crespo", name: "Hernán Crespo", country: "Argentina", position: "FWD", rating: 91 },
        { id: "aguero", name: "Sergio Agüero", country: "Argentina", position: "FWD", rating: 92 },
        { id: "torres", name: "Fernando Torres", country: "Spain", position: "FWD", rating: 90 },
        { id: "villa", name: "David Villa", country: "Spain", position: "FWD", rating: 91 },
        { id: "papin", name: "Jean-Pierre Papin", country: "France", position: "FWD", rating: 90 },
        { id: "sanchez", name: "Hugo Sánchez", country: "Mexico", position: "FWD", rating: 94 },
        { id: "rummenigge", name: "Karl-Heinz Rummenigge", country: "Germany", position: "FWD", rating: 94 },
        { id: "cantona", name: "Eric Cantona", country: "France", position: "FWD", rating: 92 },
        { id: "rossi", name: "Paolo Rossi", country: "Italy", position: "FWD", rating: 92 },
        { id: "ginola", name: "David Ginola", country: "France", position: "FWD", rating: 88 },
        { id: "litmanen", name: "Jari Litmanen", country: "Finland", position: "FWD", rating: 89 },
        { id: "suker", name: "Davor Šuker", country: "Croatia", position: "FWD", rating: 92 },
        { id: "rooney", name: "Wayne Rooney", country: "England", position: "FWD", rating: 92 },
        { id: "dalglish", name: "Kenny Dalglish", country: "Scotland", position: "FWD", rating: 93 },
        { id: "law", name: "Denis Law", country: "Scotland", position: "FWD", rating: 92 },
        { id: "greaves", name: "Jimmy Greaves", country: "England", position: "FWD", rating: 94 }
      ];

      // Helpers
      const POS_LIMITS = { GK: 1, DEF: 1, MID: 2, FWD: 2 };
      const POSITION_ORDER = ["GK", "DEF", "MID", "FWD"];
      const cloneTeam = () => ({ GK: [], DEF: [], MID: [], FWD: [], skipsLeft: 1 });
      const getCountriesFrom = (players) => Array.from(new Set(players.map(p => p.country))).sort();
      const average = (arr) => (arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0);
      function teamNeeds(team) {
        return POSITION_ORDER.reduce((acc, pos) => {
          acc[pos] = Math.max(0, POS_LIMITS[pos] - team[pos].length);
          return acc;
        }, {});
      }
      function isTeamFull(team) {
        const needs = teamNeeds(team);
        return POSITION_ORDER.every(pos => needs[pos] === 0);
      }
      function eligiblePlayersForTeam(players, country, team, pickedIds) {
        const needs = teamNeeds(team);
        return players.filter(p => p.country === country && !pickedIds.has(p.id) && needs[p.position] > 0);
      }
      function computeTeamScore(team) {
        const gkAvg = average(team.GK.map(p => p.rating));
        const defAvg = average(team.DEF.map(p => p.rating));
        const midAvg = average(team.MID.map(p => p.rating));
        const fwdAvg = average(team.FWD.map(p => p.rating));
        const base = 0.15 * gkAvg + 0.20 * defAvg + 0.30 * midAvg + 0.35 * fwdAvg;
        const luck = (Math.random() * 6) - 3;
        const score = Math.max(0, Math.min(100, base + luck));
        return { base: Number(base.toFixed(2)), luck: Number(luck.toFixed(2)), final: Number(score.toFixed(2)) };
      }

      // UI Components
      const CountryBadge = ({ country }) => (
        <span className="px-2 py-1 rounded-full bg-emerald-100 text-emerald-800 text-xs font-medium">{country}</span>
      );
      const PlayerCard = ({ p, onPick, disabled }) => (
        <button
          onClick={() => !disabled && onPick(p)}
          disabled={disabled}
          className={"w-full text-left border rounded-xl p-3 hover:shadow transition " + (disabled ? "opacity-50 cursor-not-allowed hover:shadow-none" : "")}
        >
          <div className="font-medium">{p.name}</div>
          <div className="text-xs text-gray-600">{p.country}</div>
        </button>
      );
      const Roster = ({ team, title }) => {
        const needs = teamNeeds(team);
        return (
          <div className="rounded-2xl p-4 shadow bg-white">
            <div className="text-lg font-semibold mb-2">{title}</div>
            <div className="grid grid-cols-2 gap-3">
              {POSITION_ORDER.map(pos => (
                <div key={pos} className="border rounded-xl p-3">
                  <div className="text-xs uppercase tracking-wider text-gray-600">{pos}</div>
                  {Array.from({ length: POS_LIMITS[pos] }).map((_, idx) => (
                    <div key={idx} className="mt-1 text-sm">
                      {team[pos][idx] ? (
                        <div className="font-medium">{team[pos][idx].name} <span className="text-gray-500">({team[pos][idx].country})</span></div>
                      ) : (
                        <div className="text-gray-400 italic">Empty slot</div>
                      )}
                    </div>
                  ))}
                  {needs[pos] > 0 && <div className="text-[11px] text-amber-700 mt-1">Need {needs[pos]} more</div>}
                </div>
              ))}
            </div>
            <div className="mt-2 text-xs text-gray-500">Skips left: {team.skipsLeft}</div>
          </div>
        );
      };
      const Divider = () => <div className="h-px bg-gray-200 my-4" />;

      function App() {
        // Firebase init
        useEffect(() => {
          if (FIREBASE_ENABLED && !firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
          }
        }, []);

        // Room / role
        const roomFromUrl = new URLSearchParams(window.location.search).get('room') || null;

        // Core state
        const [players] = useState(ALL_PLAYERS);
        const [countries] = useState(getCountriesFrom(players));
        const [team1, setTeam1] = useState(cloneTeam());
        const [team2, setTeam2] = useState(cloneTeam());
        const [pickedIds, setPickedIds] = useState(new Set());
        const [firstPicker, setFirstPicker] = useState(null); // 1 or 2
        const [turn, setTurn] = useState(1);
        const [currentCountry, setCurrentCountry] = useState(null);
        const [winner, setWinner] = useState(null);
        const [scores, setScores] = useState(null);

        // Online state
        const [roomId, setRoomId] = useState(roomFromUrl);
        const [isOnline, setIsOnline] = useState(!!roomFromUrl);
        const [role, setRole] = useState(roomFromUrl ? 'p2' : null); // inviter will be p1
        const [receivedRemote, setReceivedRemote] = useState(false);
        const [lastCountry, setLastCountry] = useState({ 1: null, 2: null });

        // Helpers bound to state
        const currentTeamRef = (which) => (which === 1 ? team1 : team2);
        const setCurrentTeam = (which, value) => (which === 1 ? setTeam1(value) : setTeam2(value));

        // Roll a country (tries to avoid repeating the given or last rolled)
        function rollCountry(forPlayer, avoidSameAs = null) {
          const maxAttempts = 50;
          let chosen = null;
          const avoid = (avoidSameAs ?? lastCountry[forPlayer]);

          for (let i = 0; i < maxAttempts; i++) {
            const c = countries[Math.floor(Math.random() * countries.length)];
            if (c === avoid) continue;
            const eligible = eligiblePlayersForTeam(players, c, currentTeamRef(forPlayer), pickedIds);
            if (eligible.length > 0) { chosen = c; break; }
          }
          // fallback if avoidance blocks everything
          if (!chosen) {
            for (let i = 0; i < maxAttempts; i++) {
              const c = countries[Math.floor(Math.random() * countries.length)];
              const eligible = eligiblePlayersForTeam(players, c, currentTeamRef(forPlayer), pickedIds);
              if (eligible.length > 0) { chosen = c; break; }
            }
          }
          // final fallback
          if (!chosen) chosen = countries[Math.floor(Math.random() * countries.length)];

          setCurrentCountry(chosen);
          setLastCountry(prev => ({ ...prev, [forPlayer]: chosen }));
        }

        // Start a match (host or offline)
        function startFreshMatch() {
          setTeam1(cloneTeam());
          setTeam2(cloneTeam());
          setPickedIds(new Set());
          setWinner(null);
          setScores(null);
          const coin = Math.random() < 0.5 ? 1 : 2;
          setFirstPicker(coin);
          setTurn(coin);
          setLastCountry({ 1: null, 2: null });
          rollCountry(coin);
        }

        // First load: if offline, start immediately. If joined via room, wait for remote state.
        useEffect(() => {
          if (!isOnline) startFreshMatch();
          // if online & P2, do nothing until host sends state
        }, [isOnline]);

        // Skip (forces a different country when possible)
        function useSkip() {
          const t = currentTeamRef(turn);
          if (t.skipsLeft <= 0) return;
          const updated = { ...t, skipsLeft: t.skipsLeft - 1 };
          setCurrentTeam(turn, updated);
          rollCountry(turn, currentCountry);
          setTimeout(publish, 0);
        }

        // Picking
        function addPlayerToTeam(whichTeam, player) {
          const t = currentTeamRef(whichTeam);
          const copy = { ...t, GK: [...t.GK], DEF: [...t.DEF], MID: [...t.MID], FWD: [...t.FWD] };
          copy[player.position].push(player);
          setCurrentTeam(whichTeam, copy);
          const newPicked = new Set(pickedIds); newPicked.add(player.id); setPickedIds(newPicked);
        }
        function handlePick(p) {
          addPlayerToTeam(turn, p);
          const team1Next = turn === 1 ? { ...team1, [p.position]: [...team1[p.position], p] } : team1;
          const team2Next = turn === 2 ? { ...team2, [p.position]: [...team2[p.position], p] } : team2;

          if (isTeamFull(team1Next) && isTeamFull(team2Next)) {
            const s1 = computeTeamScore(team1Next);
            const s2 = computeTeamScore(team2Next);
            const w = s1.final > s2.final ? 1 : s2.final > s1.final ? 2 : (Math.random() < 0.5 ? 1 : 2);
            setScores({ p1: s1, p2: s2 });
            setWinner(w);
            setCurrentCountry(null);
            return;
          }

          const nextTurn = turn === 1 ? 2 : 1;
          setTurn(nextTurn);
          setTimeout(() => rollCountry(nextTurn), 50);
        }
        // after setTurn(nextTurn); and setTimeout(() => rollCountry(nextTurn), 50);
          setTimeout(publish, 0);

        // Eligible list
        const eligibleList = useMemo(() => {
          if (!currentCountry) return [];
          return eligiblePlayersForTeam(players, currentCountry, currentTeamRef(turn), pickedIds);
        }, [players, currentCountry, team1, team2, pickedIds, turn]);

        let lastWriteAt = 0;
        function publish() {
          if (!FIREBASE_ENABLED || !roomId) return;
          if (role !== 'p1') return; // host-only writes
          const now = Date.now();
          if (now - lastWriteAt < 250) return; // throttle
          lastWriteAt = now;
          const snapshot = {
            team1, team2,
            pickedIds: Array.from(pickedIds),
            firstPicker, turn, currentCountry, winner, scores
          };
          firebase.firestore().collection('matches').doc(roomId)
            .set({ state: snapshot, updatedAt: now }, { merge: true });
        }


        // ----- Online: create / invite / sync -----
        async function createRoom() {
          if (!FIREBASE_ENABLED) { alert('Enable Firebase first.'); return; }
          const id = Math.random().toString(36).slice(2, 8);
          await firebase.firestore().collection('matches').doc(id).set({ state: null, updatedAt: Date.now() });
          setRoomId(id);
          setRole('p1');
          setIsOnline(true);
          history.replaceState(null, "", `?room=${id}`); // keep URL
          // host starts a fresh match and syncs
          startFreshMatch();
          setTimeout(publish, 0);
          const link = window.location.origin + window.location.pathname + `?room=${id}`;
          navigator.clipboard?.writeText(link);
          alert('Invite link copied to clipboard!');
        }

        function inviteFlow() {
          if (roomId) {
            const link = window.location.origin + window.location.pathname + `?room=${roomId}`;
            navigator.clipboard?.writeText(link);
            alert('Invite link copied!');
          } else {
            createRoom();
          }
        }

        async function syncOnline(state) {
          if (!FIREBASE_ENABLED || !roomId) return;
          await firebase.firestore().collection('matches').doc(roomId).set({ state, updatedAt: Date.now() }, { merge: true });
        }

        // Listen for remote updates (both host & joiner)
        useEffect(() => {
          if (!FIREBASE_ENABLED || !roomId) return;
          const ref = firebase.firestore().collection('matches').doc(roomId);
          const unsub = ref.onSnapshot((snap) => {
            const data = snap.data();
            if (!data || !data.state) return;
            const s = data.state;
            setTeam1(s.team1); setTeam2(s.team2); setPickedIds(new Set(s.pickedIds));
            setFirstPicker(s.firstPicker); setTurn(s.turn); setCurrentCountry(s.currentCountry);
            setWinner(s.winner); setScores(s.scores);
            setLastCountry({ 1: null, 2: null }); // reset avoidance after sync
            setReceivedRemote(true);
          });
          return () => unsub();
        }, [roomId]);

        // New Match: only host (P1) controls in online mode; anyone offline can use it
        function newMatch() {
          if (isOnline && role !== 'p1') {
            alert("Only the host (Player 1) can start a new match in this room.");
            return;
          }
          startFreshMatch(); // host will auto-sync via effect
          setTimeout(publish, 0);

        }

        const gameOver = winner !== null;
        const itIsMyTurn = !isOnline || (role === 'p1' && turn === 1) || (role === 'p2' && turn === 2);

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-8">
            <div className="max-w-6xl mx-auto">
              <header className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  <img src={LOGO_URL} alt="Winning Side" className="h-8 w-auto rounded" />
                  <h1 className="text-2xl md:text-3xl font-bold text-emerald-700">Winning Side — Prototype</h1>
                </div>
                <div className="flex items-center gap-2">
                  {FIREBASE_ENABLED && (
                    <span
                      className={
                        "px-2 py-1 rounded-full text-xs " +
                        (roomId
                          ? ((receivedRemote || role === 'p1') ? "bg-emerald-100 text-emerald-800" : "bg-amber-100 text-amber-800")
                          : "bg-gray-100 text-gray-700")
                      }
                    >
                      {roomId
                        ? ((receivedRemote || role === 'p1') ? `Room ${roomId}: Connected` : `Room ${roomId}: Waiting`)
                        : "Offline"}
                    </span>
                  )}
                  <button onClick={inviteFlow} className="px-3 py-2 rounded-xl bg-emerald-50 text-emerald-700 border border-emerald-200 text-sm">Invite</button>
                  <button onClick={newMatch} className="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm shadow">
                    New Match
                  </button>
                </div>
              </header>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <Roster team={team1} title="Player 1" />
                <Roster team={team2} title="Player 2" />
              </div>

              <Divider />

              {!gameOver ? (
                <div className="rounded-2xl p-4 md:p-6 bg-white shadow">
                  <div className="flex flex-wrap items-center gap-2 mb-3">
                    <div className="text-sm">First picker: <span className="font-semibold">Player {firstPicker}</span></div>
                    <div className="text-sm">Current turn: <span className="font-semibold">Player {turn}</span></div>
                    {currentCountry && <div className="text-sm flex items-center gap-2">Country: <CountryBadge country={currentCountry} /></div>}
                    {FIREBASE_ENABLED && isOnline && !itIsMyTurn && (
                      <div className="text-xs text-amber-700">It's Player {turn}'s turn — you're locked until they pick.</div>
                    )}
                  </div>

                  {!currentCountry && (
                    <div className="text-sm text-gray-600 mb-2">No eligible players for the rolled country. Rerolling…</div>
                  )}

                  <div className="flex items-center justify-between mb-2">
                    <div className="text-base font-semibold">Select a player</div>
                    <button onClick={useSkip} disabled={(turn === 1 ? team1.skipsLeft : team2.skipsLeft) <= 0} className="text-sm px-3 py-2 rounded-xl border hover:bg-slate-50 disabled:opacity-50">
                      Use Skip ({turn === 1 ? team1.skipsLeft : team2.skipsLeft} left)
                    </button>
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {eligibleList.length === 0 && (
                      <div className="text-sm text-gray-500">No eligible players for this country and your remaining positions. Try Skip.</div>
                    )}
                    {eligibleList.map(p => (
                      <PlayerCard key={p.id} p={p} onPick={handlePick} disabled={!itIsMyTurn} />
                    ))}
                  </div>

                  <div className="text-[11px] text-gray-500 mt-3">* Only name & country shown; ratings are hidden for the simulation.</div>
                </div>
              ) : (
                <div className="rounded-2xl p-4 md:p-6 bg-white shadow">
                  <div className="text-xl font-semibold mb-2">Result</div>
                  <div className="mb-3">Winner: <span className="font-bold">Player {winner}</span></div>
                  {scores && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="border rounded-xl p-3">
                        <div className="font-medium mb-1">Player 1</div>
                        <div className="text-sm">Base: {scores.p1.base}</div>
                        <div className="text-sm">Luck: {scores.p1.luck}</div>
                        <div className="text-sm font-semibold">Final: {scores.p1.final}</div>
                      </div>
                      <div className="border rounded-xl p-3">
                        <div className="font-medium mb-1">Player 2</div>
                        <div className="text-sm">Base: {scores.p2.base}</div>
                        <div className="text-sm">Luck: {scores.p2.luck}</div>
                        <div className="text-sm font-semibold">Final: {scores.p2.final}</div>
                      </div>
                    </div>
                  )}
                  <div className="mt-4 flex gap-2">
                    <button onClick={newMatch} className="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm">Play Again</button>
                    <button onClick={inviteFlow} className="px-4 py-2 rounded-xl border text-sm">Invite</button>
                  </div>
                </div>
              )}

              <Divider />

              <details className="text-xs text-gray-600">
                <summary className="cursor-pointer">How it works</summary>
                <div className="mt-2 space-y-1">
                  <div>- Six-a-side roster: 1 GK, 1 DEF, 2 MID, 2 FWD.</div>
                  <div>- Each turn rolls a random country. You can only pick players from that country that fit your remaining slots.</div>
                  <div>- Each player has one Skip to reroll the country (tries to avoid the same country).</div>
                  <div>- Final score combines weighted position ratings + a small luck factor (±3).</div>
                  <div>- Online invite: each room has its own link (?room=ID).</div>
                </div>
              </details>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>

